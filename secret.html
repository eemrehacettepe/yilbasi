<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Secret Santa (GerÃ§ek Gizli)</title>
  <style>
    :root{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;line-height:1.5}
    body{margin:0;min-height:100vh;display:flex;justify-content:center;align-items:flex-start;padding:18px;background:radial-gradient(circle at top,#ffecd2,#fcb69f)}
    .card{background:rgba(255,255,255,.92);max-width:760px;width:100%;padding:18px 20px;border-radius:18px;box-shadow:0 18px 40px rgba(0,0,0,.18);backdrop-filter:blur(10px)}
    h1{margin:0 0 10px 0;color:#b22222}
    .sub{margin:0 0 14px 0;color:#555;font-size:.92rem}
    label{display:block;margin-top:12px;font-weight:800;font-size:.92rem}
    input,textarea{width:100%;box-sizing:border-box;padding:10px 12px;border-radius:10px;border:1px solid #ccc;font-size:.92rem;background:#fff;margin-top:6px}
    textarea{min-height:110px;resize:vertical}
    .hint{font-size:.82rem;color:#777;margin-top:4px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{border:0;border-radius:999px;padding:10px 16px;font-weight:900;cursor:pointer;font-size:.95rem;background:linear-gradient(135deg,#ff5f6d,#ffc371);color:#fff;box-shadow:0 10px 25px rgba(0,0,0,.18)}
    .secondary{background:#eee;color:#333;box-shadow:none}
    .box{margin-top:12px;padding:12px 14px;border-radius:12px;background:#fff8e6;border:1px dashed #e0b35b;color:#5c470f;font-size:.9rem}
    .result{margin-top:14px;padding:14px;border-radius:12px;background:#f0fff4;border:1px solid #bde5c8}
    .err{margin-top:12px;color:#b00020;font-weight:900;white-space:pre-wrap}
    code{background:#f5f5f5;padding:2px 6px;border-radius:6px}
    table{width:100%;border-collapse:collapse;margin-top:10px}
    th,td{border:1px solid #ddd;padding:8px;font-size:.9rem}
    th{background:#fafafa;text-align:left}
  </style>
</head>
<body>
<div class="card" id="app">YÃ¼kleniyorâ€¦</div>

<script>
const app = document.getElementById('app');

function escapeHtml(s){return String(s).replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m]))}

function b64UrlEncodeUtf8(str){
  const bytes = new TextEncoder().encode(str);
  let bin=""; bytes.forEach(b=>bin+=String.fromCharCode(b));
  return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}
function b64UrlDecodeUtf8(b64url){
  let s=b64url.replace(/-/g,'+').replace(/_/g,'/'); while(s.length%4) s+='=';
  const bin=atob(s); const bytes=new Uint8Array(bin.length);
  for(let i=0;i<bin.length;i++) bytes[i]=bin.charCodeAt(i);
  return new TextDecoder().decode(bytes);
}

function setEventToUrl(data){ location.hash='data='+b64UrlEncodeUtf8(JSON.stringify(data)); }
function getEventFromUrl(){
  if(!location.hash.startsWith('#data=')) return null;
  try{
    const data=JSON.parse(b64UrlDecodeUtf8(location.hash.slice(6)));
    if(!data || !Array.isArray(data.participants)) return null;
    if(!Array.isArray(data.forbiddenPairs)) data.forbiddenPairs=[];
    if(!Array.isArray(data.codes)) data.codes=[];
    if(!Array.isArray(data.familyKeys)) data.familyKeys=[]; // {key, label, allows:[codes]}
    return data;
  }catch{ return null; }
}

// RNG
function xmur3(str){let h=1779033703^str.length;for(let i=0;i<str.length;i++){h=Math.imul(h^str.charCodeAt(i),3432918353);h=(h<<13)|(h>>>19)}return function(){h=Math.imul(h^(h>>>16),2246822507);h=Math.imul(h^(h>>>13),3266489909);h^=h>>>16;return h>>>0}}
function mulberry32(a){return function(){a|=0;a=a+0x6D2B79F5|0;let t=Math.imul(a^a>>>15,1|a);t=t+Math.imul(t^t>>>7,61|t)^t;return((t^t>>>14)>>>0)/4294967296}}
function makeRng(seedStr){return mulberry32(xmur3(seedStr)());}
function shuffle(arr,rng){for(let i=arr.length-1;i>0;i--){const j=Math.floor(rng()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]]}return arr}
function randCode(len=10){
  const chars="ABCDEFGHJKLMNPQRSTUVWXYZ23456789"; // karÄ±ÅŸÄ±klÄ±k azalt
  let s=""; for(let i=0;i<len;i++) s+=chars[Math.floor(Math.random()*chars.length)];
  return s;
}

// Forbidden parsing (A | B)
function parseForbidden(text){
  const lines=(text||'').split('\n').map(s=>s.trim()).filter(Boolean);
  const out=[];
  for(const line of lines){
    let parts=null;
    if(line.includes('|')) parts=line.split('|');
    else if(line.includes(',')) parts=line.split(',');
    else if(line.includes(';')) parts=line.split(';');
    else if(line.includes('->')) parts=line.split('->');
    if(!parts||parts.length<2) continue;
    const a=(parts[0]||'').trim(), b=(parts[1]||'').trim();
    if(a&&b) out.push(`${a}|${b}`);
  }
  return out;
}
function forbiddenSet(arr){return new Set((arr||[]).filter(Boolean));}

// Matching (backtracking)
function computeAssignment(names, forbid, seedStr){
  const n=names.length; const rng=makeRng(seedStr);
  const options=Array.from({length:n},(_,i)=>{
    const opts=[];
    for(let j=0;j<n;j++){
      if(i===j) continue;
      if(forbid.has(`${names[i]}|${names[j]}`)) continue;
      opts.push(j);
    }
    return shuffle(opts,rng);
  });
  for(let i=0;i<n;i++) if(options[i].length===0) return null;
  const assigned=Array(n).fill(-1);
  const used=Array(n).fill(false);
  function pickNext(){
    let best=-1,bestCount=Infinity;
    for(let i=0;i<n;i++){
      if(assigned[i]!==-1) continue;
      let c=0; for(const r of options[i]) if(!used[r]) c++;
      if(c<bestCount){bestCount=c;best=i;}
    }
    return best;
  }
  function bt(done){
    if(done===n) return true;
    const g=pickNext(); if(g===-1) return false;
    for(const r of options[g]){
      if(used[r]) continue;
      assigned[g]=r; used[r]=true;
      if(bt(done+1)) return true;
      used[r]=false; assigned[g]=-1;
    }
    return false;
  }
  return bt(0)?assigned:null;
}

// Local lock (same device)
function lockKey(eventId){ return `SS_LOCK_${eventId}`; }
function getLock(eventId){
  try{ return JSON.parse(localStorage.getItem(lockKey(eventId))||'null'); }catch{ return null; }
}
function setLock(eventId, obj){
  localStorage.setItem(lockKey(eventId), JSON.stringify(obj));
}

// Views
function renderCreate(){
  app.innerHTML=`
    <h1>Secret Santa (GerÃ§ek Gizli)</h1>
    <p class="sub">Ä°sim seÃ§me yok. Herkes sadece <b>kendi koduyla</b> sonucunu gÃ¶rÃ¼r. AynÄ± cihazda bir kere aÃ§Ä±lÄ±nca baÅŸka koda geÃ§mek kilitlenir. Ã‡ocuklar iÃ§in â€œaile moduâ€ var.</p>

    <label>Etkinlik adÄ±</label>
    <input id="name" placeholder="Ã–rn: Aile Ã‡ekiliÅŸi">

    <label>KatÄ±lÄ±mcÄ±lar (her satÄ±r bir isim)</label>
    <textarea id="people" placeholder="Emre
Bengi
Burcu
Beraat"></textarea>
    <div class="hint">Ä°simler benzersiz olmalÄ±.</div>

    <label>Yasak eÅŸleÅŸmeler (isteÄŸe baÄŸlÄ±) â€” A | B</label>
    <textarea id="forb" placeholder="Burcu | Beraat
Beraat | Burcu"></textarea>

    <label>Aile modu (isteÄŸe baÄŸlÄ±)</label>
    <textarea id="families" placeholder="Aile1: Ã‡ocukAdÄ±1, Ã‡ocukAdÄ±2
Aile2: Ã‡ocukAdÄ±3"></textarea>
    <div class="hint">Ã‡ocuklarÄ±n interneti yoksa: ebeveyne bir â€œAile AnahtarÄ±â€ vereceÄŸiz. O anahtar, o ailedeki Ã§ocuklarÄ±n kodlarÄ±nÄ± aynÄ± telefonda aÃ§maya izin verir.</div>

    <div class="row">
      <button id="go">EtkinliÄŸi oluÅŸtur</button>
    </div>
    <div class="err" id="err"></div>
  `;

  document.getElementById('go').onclick=()=>{
    const err=document.getElementById('err'); err.textContent='';
    const name=(document.getElementById('name').value.trim()||'Secret Santa');
    const peopleRaw=document.getElementById('people').value.trim();
    if(!peopleRaw){ err.textContent='KatÄ±lÄ±mcÄ± girmelisin.'; return; }
    const participants=peopleRaw.split('\n').map(s=>s.trim()).filter(Boolean);
    if(participants.length<3){ err.textContent='En az 3 kiÅŸi olmalÄ±.'; return; }
    const uniq=new Set(participants);
    if(uniq.size!==participants.length){ err.textContent='Ä°simler benzersiz olmalÄ±.'; return; }

    const forbArr=parseForbidden(document.getElementById('forb').value);
    for(const p of forbArr){
      const [a,b]=p.split('|');
      if(!uniq.has(a)||!uniq.has(b)){ err.textContent=`Yasak eÅŸleÅŸmede listede olmayan isim var: "${a} | ${b}"`; return; }
    }

    const seed=randCode(12);
    const forbid=forbiddenSet(forbArr);
    const assignment=computeAssignment(participants, forbid, seed);
    if(!assignment){ err.textContent='Bu kÄ±sÄ±tlarla Ã§ekiliÅŸ mÃ¼mkÃ¼n deÄŸil. YasaklarÄ± azalt.'; return; }

    // codes: per participant
    const codes = participants.map((p,i)=>({ code: randCode(10), name:p, idx:i }));
    const codeToIdx = new Map(codes.map(c=>[c.code, c.idx]));

    // family keys parse (very simple)
    const famRaw = document.getElementById('families').value.trim();
    const familyKeys=[];
    if(famRaw){
      const lines=famRaw.split('\n').map(s=>s.trim()).filter(Boolean);
      for(const line of lines){
        const parts=line.split(':');
        if(parts.length<2) continue;
        const label=parts[0].trim();
        const kids=parts[1].split(',').map(s=>s.trim()).filter(Boolean);
        const allows=[];
        for(const kid of kids){
          if(!uniq.has(kid)){ err.textContent=`Aile listesinde olmayan isim: "${kid}"`; return; }
          // kid's code
          const kidCode = codes.find(c=>c.name===kid)?.code;
          if(kidCode) allows.push(kidCode);
        }
        if(allows.length){
          familyKeys.push({ label, key: randCode(8), allows });
        }
      }
    }

    // event id to lock on device (short)
    const eventId = randCode(8);

    const data={
      v:1,
      eventId,
      name,
      participants,
      forbiddenPairs: forbArr,
      seed,
      // store assignment indirectly by seed+constraints; we store assignment indexes to avoid recompute differences
      assignment,
      codes,
      familyKeys
    };

    setEventToUrl(data);
    renderAdminCodes(data);
  };
}

function renderAdminCodes(data){
  const rows = data.codes.map(c=>`<tr><td>${escapeHtml(c.name)}</td><td><code>${escapeHtml(c.code)}</code></td></tr>`).join('');
  const famRows = data.familyKeys.length
    ? data.familyKeys.map(f=>`<tr><td>${escapeHtml(f.label)}</td><td><code>${escapeHtml(f.key)}</code></td><td>${f.allows.length} Ã§ocuk</td></tr>`).join('')
    : `<tr><td colspan="3">Aile modu tanÄ±mlanmadÄ±.</td></tr>`;

  app.innerHTML=`
    <h1>${escapeHtml(data.name)}</h1>
    <p class="sub"><b>YÃ¶netici ekranÄ±:</b> KiÅŸi kodlarÄ±nÄ± buradan daÄŸÄ±tacaksÄ±n. Herkes siteye girip sadece kodunu yazar. Linki gruba atabilirsin, kodlarÄ± kiÅŸiye Ã¶zel gÃ¶nder.</p>

    <div class="box">
      <b>Etkinlik linki (gruba at):</b><br>
      <span id="link"></span>
    </div>

    <h3>KiÅŸi KodlarÄ±</h3>
    <table>
      <tr><th>Ä°sim</th><th>Kod</th></tr>
      ${rows}
    </table>
    <p class="hint">Bu kodlarÄ± kiÅŸiye Ã¶zel WhatsAppâ€™tan gÃ¶nder. (Kodunu bilen sonucu gÃ¶rÃ¼r.)</p>

    <h3>Aile Modu (Ebeveyn AnahtarlarÄ±)</h3>
    <table>
      <tr><th>Etiket</th><th>Aile AnahtarÄ±</th><th>Ä°zin</th></tr>
      ${famRows}
    </table>
    <p class="hint">Ebeveyn, kendi telefonu Ã¼zerinden Ã¶nce <b>aile anahtarÄ±nÄ±</b> girerse aynÄ± telefonda birden fazla Ã§ocuk kodu aÃ§abilir. Aile anahtarÄ± yoksa telefon ilk baktÄ±ÄŸÄ± kodla kilitlenir.</p>

    <div class="row">
      <button id="open">KatÄ±lÄ±mcÄ± ekranÄ±na geÃ§</button>
      <button id="new" class="secondary">Yeni etkinlik oluÅŸtur</button>
    </div>
  `;
  document.getElementById('link').textContent = location.href.replace(/#data=.*/, '') + location.hash;
  document.getElementById('open').onclick=()=>renderParticipant(data);
  document.getElementById('new').onclick=()=>{
    history.pushState("", document.title, location.pathname + location.search);
    renderCreate();
  };
}

function renderParticipant(data){
  app.innerHTML=`
    <h1>${escapeHtml(data.name)}</h1>
    <p class="sub">Kodunu gir. Kod sadece <b>senin sonucunu</b> aÃ§ar. AynÄ± cihazda ilk aÃ§Ä±lan kod kilit olur (aile modu hariÃ§).</p>

    <label>Kod</label>
    <input id="code" placeholder="Ã–rn: 8H7K2M9P3Q">

    <label>Aile anahtarÄ± (sadece ebeveynler iÃ§in)</label>
    <input id="family" placeholder="Varsa gir (opsiyonel)">

    <div class="row">
      <button id="show">Sonucu gÃ¶ster</button>
      <button id="back" class="secondary">YÃ¶netici ekranÄ±</button>
    </div>

    <div class="result" id="res" style="display:none;"></div>
    <div class="err" id="err"></div>
  `;

  document.getElementById('back').onclick=()=>renderAdminCodes(data);

  document.getElementById('show').onclick=()=>{
    const err=document.getElementById('err');
    const res=document.getElementById('res');
    err.textContent=''; res.style.display='none';

    const code=document.getElementById('code').value.trim().toUpperCase();
    const fam=document.getElementById('family').value.trim().toUpperCase();

    if(!code){ err.textContent='Kod gir.'; return; }

    const codeRec = data.codes.find(c=>c.code===code);
    if(!codeRec){ err.textContent='Kod bulunamadÄ±.'; return; }

    // device lock logic
    const lock = getLock(data.eventId);
    const isFamilyUnlocked = fam && data.familyKeys.some(f=>f.key===fam && f.allows.includes(code));

    if(lock){
      // already locked: allow only same code OR family-unlocked codes
      if(lock.code !== code && !isFamilyUnlocked){
        err.textContent = 'Bu cihaz daha Ã¶nce baÅŸka bir koda kilitlendi. BaÅŸka kiÅŸiyi sorgulayamazsÄ±n. (Ebeveynsen aile anahtarÄ± gir.)';
        return;
      }
    }else{
      // first time: lock this device to this code unless family-unlock used
      if(!isFamilyUnlocked){
        setLock(data.eventId, { code, at: Date.now() });
      }
    }

    const giverIdx = codeRec.idx;
    const targetIdx = data.assignment[giverIdx];
    const targetName = data.participants[targetIdx];

    res.innerHTML=`
      <h3>SonuÃ§</h3>
      <p><b>${escapeHtml(codeRec.name)}</b> iÃ§in hediye alÄ±nacak kiÅŸi:</p>
      <p style="font-size:1.35rem;font-weight:950;margin:.35rem 0 0 0;">ğŸ ${escapeHtml(targetName)}</p>
      <p class="hint">Not al. AynÄ± kodla tekrar aÃ§arsan aynÄ± sonucu gÃ¶rÃ¼rsÃ¼n.</p>
    `;
    res.style.display='block';
  };
}

function init(){
  const data=getEventFromUrl();
  if(!data) renderCreate();
  else renderAdminCodes(data);
}

window.addEventListener('error', ev=>{
  app.innerHTML = `<h1>Hata</h1><div class="err">${escapeHtml(String(ev.error?.stack||ev.message||ev.error))}</div>`;
});
init();
</script>
</body>
</html>

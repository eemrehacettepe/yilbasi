<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>YÄ±lbaÅŸÄ± Ã‡ekiliÅŸi</title>
  <style>
    :root{font-family:system-ui,-apple-system,"Segoe UI",sans-serif;line-height:1.5}
    body{margin:0;min-height:100vh;display:flex;justify-content:center;align-items:flex-start;padding:18px;background:radial-gradient(circle at top,#ffecd2,#fcb69f)}
    .card{background:rgba(255,255,255,.92);max-width:780px;width:100%;padding:18px 20px;border-radius:18px;box-shadow:0 18px 40px rgba(0,0,0,.18);backdrop-filter:blur(10px)}
    h1,h2,h3{margin:0 0 10px 0;color:#b22222}
    .sub{margin:0 0 14px 0;color:#555;font-size:.92rem}
    label{display:block;margin-top:12px;font-weight:950;font-size:.92rem}
    input,textarea,select{width:100%;box-sizing:border-box;padding:10px 12px;border-radius:10px;border:1px solid #ccc;font-size:.92rem;background:#fff;margin-top:6px}
    textarea{min-height:110px;resize:vertical}
    .hint{font-size:.82rem;color:#777;margin-top:4px}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin-top:12px}
    button{border:0;border-radius:999px;padding:10px 16px;font-weight:950;cursor:pointer;font-size:.95rem;background:linear-gradient(135deg,#ff5f6d,#ffc371);color:#fff;box-shadow:0 10px 25px rgba(0,0,0,.18)}
    .secondary{background:#eee;color:#333;box-shadow:none}
    .box{margin-top:12px;padding:12px 14px;border-radius:12px;background:#fff8e6;border:1px dashed #e0b35b;color:#5c470f;font-size:.9rem}
    .result{margin-top:14px;padding:14px;border-radius:12px;background:#f0fff4;border:1px solid #bde5c8}
    .err{margin-top:12px;color:#b00020;font-weight:950;white-space:pre-wrap}
    code{background:#f5f5f5;padding:2px 6px;border-radius:6px}
    .link{margin-top:14px;padding:12px 14px;border-radius:12px;background:#f5f5ff;border:1px solid #cfd4ff;word-break:break-all;font-size:.88rem}
    .pill{display:inline-block;padding:2px 10px;border-radius:999px;background:#f2f2f2;font-size:.8rem;margin-left:6px}
  </style>
</head>
<body>
<div class="card" id="app">YÃ¼kleniyorâ€¦</div>

<script>
(() => {
  const app = document.getElementById('app');

  // ===== Helpers =====
  function escapeHtml(s){
    return String(s).replace(/[&<>"']/g, m => ({
      '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'
    }[m]));
  }

  // UTF-8 safe Base64URL
  function b64UrlEncodeUtf8(str){
    const bytes = new TextEncoder().encode(str);
    let bin = "";
    bytes.forEach(b => bin += String.fromCharCode(b));
    return btoa(bin).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
  }
  function b64UrlDecodeUtf8(b64url){
    let s = b64url.replace(/-/g,'+').replace(/_/g,'/');
    while (s.length % 4) s += '=';
    const bin = atob(s);
    const bytes = new Uint8Array(bin.length);
    for (let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
    return new TextDecoder().decode(bytes);
  }

  function setEventToUrl(data){
    location.hash = 'data=' + b64UrlEncodeUtf8(JSON.stringify(data));
  }
  function getEventFromUrl(){
    if (!location.hash.startsWith('#data=')) return null;
    try{
      const json = b64UrlDecodeUtf8(location.hash.slice(6));
      const data = JSON.parse(json);
      if (!data || !Array.isArray(data.participants)) return null;
      if (!Array.isArray(data.forbiddenPairs)) data.forbiddenPairs = [];
      if (!Array.isArray(data.children)) data.children = [];
      if (typeof data.seed !== 'string') data.seed = 'seed';
      if (typeof data.eventId !== 'string') data.eventId = 'event';
      return data;
    } catch {
      return null;
    }
  }

  // ===== Deterministic RNG =====
  function xmur3(str){
    let h = 1779033703 ^ str.length;
    for (let i=0;i<str.length;i++){
      h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
      h = (h<<13) | (h>>>19);
    }
    return function(){
      h = Math.imul(h ^ (h>>>16), 2246822507);
      h = Math.imul(h ^ (h>>>13), 3266489909);
      h ^= h>>>16;
      return h>>>0;
    };
  }
  function mulberry32(a){
    return function(){
      a |= 0; a = a + 0x6D2B79F5 | 0;
      let t = Math.imul(a ^ a>>>15, 1|a);
      t = t + Math.imul(t ^ t>>>7, 61|t) ^ t;
      return ((t ^ t>>>14)>>>0) / 4294967296;
    };
  }
  function makeRng(seedStr){
    return mulberry32(xmur3(seedStr)());
  }
  function shuffle(arr, rng){
    for (let i=arr.length-1;i>0;i--){
      const j = Math.floor(rng()*(i+1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }
  function randomSeed(){
    return Math.random().toString(36).slice(2,10);
  }

  // ===== Forbidden parsing (A | B) =====
  function parseForbidden(text){
    const lines = (text||'').split('\n').map(s=>s.trim()).filter(Boolean);
    const out = [];
    for (const line of lines){
      let parts = null;
      if (line.includes('|')) parts = line.split('|');
      else if (line.includes(',')) parts = line.split(',');
      else if (line.includes(';')) parts = line.split(';');
      else if (line.includes('->')) parts = line.split('->');
      if (!parts || parts.length < 2) continue;
      const a = (parts[0]||'').trim();
      const b = (parts[1]||'').trim();
      if (a && b) out.push(`${a}|${b}`);
    }
    return out;
  }
  function forbiddenSet(arr){
    return new Set((arr||[]).filter(Boolean));
  }

  // ===== Constraint matching (backtracking) =====
  function computeAssignment(names, forbid, seedStr){
    const n = names.length;
    const rng = makeRng(seedStr);

    const options = Array.from({length:n}, (_, i) => {
      const opts = [];
      for (let j=0;j<n;j++){
        if (i===j) continue;
        if (forbid.has(`${names[i]}|${names[j]}`)) continue;
        opts.push(j);
      }
      return shuffle(opts, rng);
    });

    for (let i=0;i<n;i++) if (options[i].length === 0) return null;

    const assigned = Array(n).fill(-1);
    const used = Array(n).fill(false);

    function pickNext(){
      let best=-1, bestCount=Infinity;
      for (let i=0;i<n;i++){
        if (assigned[i] !== -1) continue;
        let c=0;
        for (const r of options[i]) if (!used[r]) c++;
        if (c < bestCount){ bestCount=c; best=i; }
      }
      return best;
    }

    function bt(done){
      if (done === n) return true;
      const g = pickNext();
      if (g === -1) return false;
      for (const r of options[g]){
        if (used[r]) continue;
        assigned[g] = r;
        used[r] = true;
        if (bt(done+1)) return true;
        used[r] = false;
        assigned[g] = -1;
      }
      return false;
    }

    return bt(0) ? assigned : null;
  }

  // ===== Device lock: adults lock to first adult viewed; children unlimited =====
  function lockKey(eventId){
    return `SS_ADULT_LOCK_${eventId}`;
  }
  function getAdultLock(eventId){
    return localStorage.getItem(lockKey(eventId));
  }
  function setAdultLock(eventId, name){
    localStorage.setItem(lockKey(eventId), name);
  }

  // ===== UI =====
  function renderCreate(){
    app.innerHTML = `
      <h1>YÄ±lbaÅŸÄ± Ã‡ekiliÅŸi</h1>
      <p class="sub">KÄ±sÄ±tlÄ± Ã§ekiliÅŸ + â€œÃ§ocuklar sÄ±nÄ±rsÄ±z, yetiÅŸkinler tek isim kilidiâ€. AmaÃ§: tÃ¼m isimleri tek tek kurcalamak kolay olmasÄ±n.</p>

      <label>Etkinlik adÄ±</label>
      <input id="name" value="YÄ±lbaÅŸÄ± Ã‡ekiliÅŸi" placeholder="Ã–rn: YÄ±lbaÅŸÄ± Ã‡ekiliÅŸi">

      <label>Etkinlik tarihi (isteÄŸe baÄŸlÄ±)</label>
      <input id="date" type="date">

      <label>BÃ¼tÃ§e (isteÄŸe baÄŸlÄ±)</label>
      <input id="budget" type="number" min="0" step="1" placeholder="Ã–rn: 300">

      <label>KatÄ±lÄ±mcÄ±lar (her satÄ±r bir isim)</label>
      <textarea id="people" placeholder="Emre
Bengi
Burcu
Beraat"></textarea>
      <div class="hint">Ä°simler benzersiz olmalÄ±. AynÄ± isim varsa ayÄ±r (Mehmet A., Mehmet B.).</div>

      <label>Ã‡ocuklar (opsiyonel) <span class="pill">Bu listedekiler sÄ±nÄ±rsÄ±z gÃ¶rÃ¼ntÃ¼lenir</span></label>
      <textarea id="children" placeholder="Ã‡ocuk1
Ã‡ocuk2"></textarea>
      <div class="hint">Buraya yazdÄ±ÄŸÄ±n isimler katÄ±lÄ±mcÄ± listesinde de aynen bulunmalÄ±.</div>

      <label>Yasak eÅŸleÅŸmeler (isteÄŸe baÄŸlÄ±) â€” A | B</label>
      <textarea id="forbidden" placeholder="Burcu | Beraat
Beraat | Burcu"></textarea>
      <div class="hint">â€œA | Bâ€ demek: A kiÅŸisi Bâ€™ye hediye alamaz. KarÅŸÄ±lÄ±klÄ± yasak iÃ§in iki satÄ±r yaz.</div>

      <div class="box">
        <b>Kural:</b> Ã‡ocuklar kutusundaki isimler bu cihazda sÄ±nÄ±rsÄ±z gÃ¶rÃ¼ntÃ¼lenebilir.
        <br><b>YetiÅŸkinler:</b> Bu cihazda ilk gÃ¶rÃ¼ntÃ¼lenen yetiÅŸkin ismine kilitlenir; baÅŸka yetiÅŸkin gÃ¶rÃ¼ntÃ¼lenemez.
      </div>

      <div class="row">
        <button id="create">EtkinliÄŸi OluÅŸtur</button>
      </div>
      <div class="err" id="err"></div>
    `;

    document.getElementById('create').onclick = () => {
      const err = document.getElementById('err');
      err.textContent = '';

      const name = (document.getElementById('name').value.trim() || 'YÄ±lbaÅŸÄ± Ã‡ekiliÅŸi');
      const date = document.getElementById('date').value || null;
      const budgetRaw = document.getElementById('budget').value.trim();
      const budget = budgetRaw ? Number(budgetRaw) : null;

      const peopleRaw = document.getElementById('people').value.trim();
      if (!peopleRaw){ err.textContent = 'KatÄ±lÄ±mcÄ± girmelisin.'; return; }
      const participants = peopleRaw.split('\n').map(s=>s.trim()).filter(Boolean);
      if (participants.length < 3){ err.textContent = 'En az 3 kiÅŸi olmalÄ±.'; return; }

      const uniq = new Set(participants);
      if (uniq.size !== participants.length){
        err.textContent = 'Ä°simler benzersiz olmalÄ± (Mehmet A., Mehmet B. gibi ayÄ±r).';
        return;
      }

      const childrenRaw = document.getElementById('children').value.trim();
      const children = childrenRaw ? childrenRaw.split('\n').map(s=>s.trim()).filter(Boolean) : [];

      // children validation
      const childSet = new Set(children);
      for (const c of childSet){
        if (!uniq.has(c)){
          err.textContent = `Ã‡ocuklar listesinde katÄ±lÄ±mcÄ±larda olmayan isim var: "${c}"`;
          return;
        }
      }

      const forbArr = parseForbidden(document.getElementById('forbidden').value);
      for (const p of forbArr){
        const [a,b] = p.split('|');
        if (!uniq.has(a) || !uniq.has(b)){
          err.textContent = `Yasak eÅŸleÅŸmede listede olmayan isim var: "${a} | ${b}"`;
          return;
        }
      }

      const seed = randomSeed();
      const eventId = randomSeed(); // cihaz kilidi iÃ§in
      const forbid = forbiddenSet(forbArr);
      const assignment = computeAssignment(participants, forbid, seed);

      if (!assignment){
        err.textContent = 'Bu kÄ±sÄ±tlarla Ã§ekiliÅŸ mÃ¼mkÃ¼n deÄŸil. YasaklarÄ± azaltmayÄ± deneyin.';
        return;
      }

      const data = { name, date, budget, participants, children: Array.from(childSet), forbiddenPairs: forbArr, seed, eventId, assignment };
      setEventToUrl(data);
      renderParticipant(data);
    };
  }

  function renderParticipant(data){
    const participants = data.participants;
    const assignment = data.assignment;
    const childSet = new Set(data.children || []);
    const eventId = data.eventId || 'event';

    app.innerHTML = `
      <h1>${escapeHtml(data.name)}</h1>
      <p class="sub">${data.date ? `Tarih: <b>${escapeHtml(data.date)}</b>` : 'Tarih: belirtilmedi.'}
      ${data.children?.length ? `<span class="pill">Ã‡ocuklar: ${data.children.length}</span>` : ''}</p>

      ${data.budget != null ? `<div class="box">BÃ¼tÃ§e: yaklaÅŸÄ±k <b>${data.budget} â‚º</b></div>` : ''}

      <label>Ä°smini seÃ§</label>
      <select id="me">
        <option value="">-- Ä°smini seÃ§ --</option>
        ${participants.map(p => {
          const tag = childSet.has(p) ? ' (Ã§ocuk)' : '';
          return `<option value="${escapeHtml(p)}">${escapeHtml(p)}${tag}</option>`;
        }).join('')}
      </select>

      <div class="hint">
        <b>Ã‡ocuklar</b> sÄ±nÄ±rsÄ±z gÃ¶rÃ¼ntÃ¼lenir. <b>YetiÅŸkinlerde</b> cihaz ilk gÃ¶rÃ¼ntÃ¼lenen yetiÅŸkine kilitlenir.
      </div>

      <div class="row">
        <button id="show">Sonucu GÃ¶ster</button>
        <button id="copy" class="secondary">Linki Kopyala</button>
        <button id="new" class="secondary">Yeni Etkinlik</button>
      </div>

      <div class="result" id="res" style="display:none;"></div>
      <div class="err" id="err"></div>

      <div class="link"><b>Etkinlik linki:</b><br><span id="link"></span></div>
      <div class="hint">YetiÅŸkin kilidi (bu cihaz): <code id="lock"></code></div>
    `;

    document.getElementById('link').textContent = location.href;

    // show current lock
    const lockNow = getAdultLock(eventId);
    document.getElementById('lock').textContent = lockNow ? lockNow : '(kilit yok)';

    document.getElementById('copy').onclick = async () => {
      try{
        await navigator.clipboard.writeText(location.href);
        alert('Link kopyalandÄ±. WhatsApp grubuna yapÄ±ÅŸtÄ±rabilirsin.');
      } catch {
        alert('KopyalayamadÄ±m. Linki elle seÃ§ip kopyalayabilirsin.');
      }
    };

    document.getElementById('new').onclick = () => {
      history.pushState("", document.title, location.pathname + location.search);
      renderCreate();
    };

    document.getElementById('show').onclick = () => {
      const err = document.getElementById('err');
      const res = document.getElementById('res');
      err.textContent = '';
      res.style.display = 'none';

      const me = document.getElementById('me').value;
      if (!me){ err.textContent = 'Ã–nce kendi ismini seÃ§.'; return; }

      const isChild = childSet.has(me);

      // Adult lock logic
      if (!isChild){
        const lockedAdult = getAdultLock(eventId);
        if (lockedAdult && lockedAdult !== me){
          err.textContent = `Bu cihaz yetiÅŸkin olarak "${lockedAdult}" adÄ±na kilitli. BaÅŸka yetiÅŸkin gÃ¶rÃ¼ntÃ¼lenemez. (Ã‡ocuklar gÃ¶rÃ¼ntÃ¼lenebilir.)`;
          return;
        }
        if (!lockedAdult){
          setAdultLock(eventId, me);
          document.getElementById('lock').textContent = me;
        }
      }

      const i = participants.indexOf(me);
      const target = participants[assignment[i]];
      const targetIsChild = childSet.has(target);

      res.innerHTML = `
        <h3>SonuÃ§</h3>
        <p><b>${escapeHtml(me)}</b> iÃ§in hediye alÄ±nacak kiÅŸi:</p>
        <p style="font-size:1.35rem;font-weight:950;margin:.35rem 0 0 0;">
          ğŸ ${escapeHtml(target)} ${targetIsChild ? '<span class="pill">Ã§ocuk</span>' : ''}
        </p>
        <div class="hint">${isChild ? 'Bu kiÅŸi â€œÃ§ocukâ€ olarak iÅŸaretli; sÄ±nÄ±rsÄ±z gÃ¶rÃ¼ntÃ¼lenebilir.' : 'Bu kiÅŸi â€œyetiÅŸkinâ€ olarak kilidi etkiler.'}</div>
      `;
      res.style.display = 'block';
    };
  }

  function init(){
    const data = getEventFromUrl();
    if (data) renderParticipant(data);
    else renderCreate();
  }

  window.addEventListener('hashchange', init);
  window.addEventListener('error', ev => {
    app.innerHTML = `<h1>Hata</h1><div class="err">${escapeHtml(String(ev.error?.stack || ev.message || ev.error))}</div>`;
  });

  init();
})();
</script>
</body>
</html>

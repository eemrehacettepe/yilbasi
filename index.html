<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Yılbaşı Çekilişi (Kısıtlı)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root { font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; line-height: 1.5; }
    body {
      margin: 0; min-height: 100vh; display: flex; justify-content: center; align-items: flex-start;
      padding: 1.5rem; background: radial-gradient(circle at top, #ffecd2, #fcb69f);
    }
    .card {
      background: rgba(255,255,255,0.92); max-width: 680px; width: 100%;
      padding: 1.5rem 1.75rem; border-radius: 18px;
      box-shadow: 0 18px 40px rgba(0,0,0,0.18); backdrop-filter: blur(10px);
    }
    h1,h2,h3 { margin-top: 0; color: #b22222; }
    .subtitle { margin-top: -0.5rem; margin-bottom: 1rem; font-size: 0.9rem; color: #555; }
    label { display:block; margin-top: 0.9rem; font-weight: 700; font-size: 0.9rem; }
    input[type="text"], input[type="date"], input[type="number"], textarea, select {
      width: 100%; padding: 0.55rem 0.7rem; border-radius: 10px; border: 1px solid #ccc;
      margin-top: 0.3rem; box-sizing: border-box; font-size: 0.9rem; background: #fff;
    }
    textarea { min-height: 120px; resize: vertical; }
    button {
      border: none; border-radius: 999px; padding: 0.6rem 1.3rem; font-weight: 700; font-size: 0.95rem;
      cursor: pointer; margin-top: 1rem; background: linear-gradient(135deg, #ff5f6d, #ffc371);
      color: #fff; box-shadow: 0 10px 25px rgba(0,0,0,0.18);
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.15s;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 13px 30px rgba(0,0,0,0.25); opacity: 0.95; }
    button:active { transform: translateY(1px) scale(0.99); box-shadow: 0 6px 16px rgba(0,0,0,0.2); }
    .btn-secondary { background: #eee; color: #333; box-shadow: none; }
    .btn-row { display:flex; gap: 0.6rem; flex-wrap: wrap; }
    .info-box {
      background: #fff8e6; border-radius: 12px; padding: 0.7rem 0.8rem; font-size: 0.85rem;
      margin-top: 0.7rem; border: 1px dashed #e0b35b; color: #5c470f;
    }
    .result-box {
      background: #f0fff4; border-radius: 12px; padding: 0.9rem 1rem;
      border: 1px solid #bde5c8; margin-top: 1rem; font-size: 0.95rem;
    }
    .error { color: #b00020; font-size: 0.9rem; margin-top: 0.6rem; font-weight: 600; }
    .field-hint { font-size: 0.8rem; color: #777; margin-top: 0.15rem; }
    .small-meta { font-size: 0.8rem; color: #666; }
    code { font-size: 0.8rem; padding: 0.15rem 0.3rem; border-radius: 4px; background: #f5f5f5; }
    .link-box {
      background: #f5f5ff; border-radius: 12px; padding: 0.75rem 0.9rem; font-size: 0.85rem;
      border: 1px solid #cfd4ff; margin-top: 0.9rem; word-break: break-all;
    }
    @media (max-width: 640px) { body{padding:0.75rem;} .card{padding:1.1rem 1.2rem; border-radius:14px;} }
  </style>
</head>
<body>
  <div class="card" id="app"></div>

  <script>
    // ------------------ URL encode/decode ------------------

    function base64UrlEncode(str) {
      return btoa(unescape(encodeURIComponent(str)))
        .replace(/\+/g, '-').replace(/\//g, '_').replace(/=+$/, '');
    }

    function base64UrlDecode(str) {
      str = str.replace(/-/g, '+').replace(/_/g, '/');
      while (str.length % 4) str += '=';
      return decodeURIComponent(escape(atob(str)));
    }

    function getEventFromUrl() {
      const hash = window.location.hash;
      if (!hash.startsWith('#data=')) return null;
      try {
        const encoded = hash.slice(6);
        const json = base64UrlDecode(encoded);
        const data = JSON.parse(json);
        if (!data || !Array.isArray(data.participants)) return null;
        // forbiddenPairs: array of "A|B"
        if (!Array.isArray(data.forbiddenPairs)) data.forbiddenPairs = [];
        return data;
      } catch {
        return null;
      }
    }

    function setEventToUrl(data) {
      const json = JSON.stringify(data);
      const encoded = base64UrlEncode(json);
      window.location.hash = 'data=' + encoded;
    }

    // ------------------ Deterministic RNG ------------------

    function xmur3(str) {
      let h = 1779033703 ^ str.length;
      for (let i = 0; i < str.length; i++) {
        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
        h = (h << 13) | (h >>> 19);
      }
      return function() {
        h = Math.imul(h ^ (h >>> 16), 2246822507);
        h = Math.imul(h ^ (h >>> 13), 3266489909);
        h ^= h >>> 16;
        return h >>> 0;
      };
    }

    function mulberry32(a) {
      return function() {
        a |= 0;
        a = a + 0x6D2B79F5 | 0;
        let t = Math.imul(a ^ a >>> 15, 1 | a);
        t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
    }

    function makeSeededRng(seedStr) {
      const seedFn = xmur3(seedStr);
      return mulberry32(seedFn());
    }

    function shuffleInPlace(arr, rng) {
      for (let i = arr.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [arr[i], arr[j]] = [arr[j], arr[i]];
      }
      return arr;
    }

    function randomSeed() {
      return Math.random().toString(36).slice(2, 10);
    }

    // ------------------ Forbidden parsing ------------------

    // Kullanıcı: satır satır "Ayşe | Mehmet" ya da "Ayşe,Mehmet" yazabilir
    function parseForbiddenTextarea(text) {
      const lines = (text || '').split('\n').map(s => s.trim()).filter(Boolean);
      const pairs = [];
      for (const line of lines) {
        // ayırıcı: | veya , veya ; veya ->
        let parts = null;

        if (line.includes('|')) parts = line.split('|');
        else if (line.includes(',')) parts = line.split(',');
        else if (line.includes(';')) parts = line.split(';');
        else if (line.includes('->')) parts = line.split('->');

        if (!parts || parts.length < 2) continue;

        const a = (parts[0] || '').trim();
        const b = (parts[1] || '').trim();
        if (a && b) pairs.push(`${a}|${b}`);
      }
      return pairs;
    }

    function buildForbiddenSet(forbiddenPairsArray) {
      return new Set((forbiddenPairsArray || []).filter(Boolean));
    }

    // ------------------ Constraint matching (Backtracking) ------------------

    // returns assignment array 'receiverIndexForGiverIndex' or null
    function computeAssignment(names, forbiddenSet, seedStr) {
      const n = names.length;
      const rng = makeSeededRng(seedStr);

      // receivers list for each giver
      const options = Array.from({length: n}, (_, i) => {
        const opts = [];
        for (let j = 0; j < n; j++) {
          if (i === j) continue; // no self
          const giver = names[i];
          const receiver = names[j];
          if (forbiddenSet.has(`${giver}|${receiver}`)) continue;
          opts.push(j);
        }
        // deterministic random order
        return shuffleInPlace(opts, rng);
      });

      // Fail fast: someone has no options
      for (let i = 0; i < n; i++) {
        if (options[i].length === 0) return null;
      }

      const assignedReceiver = Array(n).fill(-1);
      const usedReceiver = Array(n).fill(false);

      // choose next giver by MRV (minimum remaining values)
      function pickNextGiver() {
        let best = -1;
        let bestCount = Infinity;
        for (let i = 0; i < n; i++) {
          if (assignedReceiver[i] !== -1) continue;
          let count = 0;
          for (const r of options[i]) if (!usedReceiver[r]) count++;
          if (count < bestCount) {
            bestCount = count;
            best = i;
          }
        }
        return best;
      }

      function backtrack(filled) {
        if (filled === n) return true;

        const giverIndex = pickNextGiver();
        if (giverIndex === -1) return false;

        // try candidates
        for (const rIndex of options[giverIndex]) {
          if (usedReceiver[rIndex]) continue;
          assignedReceiver[giverIndex] = rIndex;
          usedReceiver[rIndex] = true;

          if (backtrack(filled + 1)) return true;

          usedReceiver[rIndex] = false;
          assignedReceiver[giverIndex] = -1;
        }
        return false;
      }

      const ok = backtrack(0);
      return ok ? assignedReceiver : null;
    }

    // ------------------ UI ------------------

    const app = document.getElementById('app');

    function renderCreateView() {
      app.innerHTML = `
        <h1>Yılbaşı Çekilişi Etkinliği Oluştur</h1>
        <p class="subtitle">Kısıtlı çekiliş: kimse kendine çıkmaz + istediğin “yasak eşleşmeler” (ör. karı-koca) oluşmaz.</p>

        <label>Etkinlik adı</label>
        <input id="event-name" type="text" placeholder="Örn: Aile Yılbaşı Çekilişi">

        <label>Etkinlik tarihi</label>
        <input id="event-date" type="date">

        <label>Bütçe (isteğe bağlı)</label>
        <input id="event-budget" type="num

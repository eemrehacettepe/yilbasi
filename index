<!DOCTYPE html>
<html lang="tr">
<head>
  <meta charset="UTF-8">
  <title>Secret Santa â€“ Aile & ArkadaÅŸ Grubu</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      line-height: 1.5;
      color-scheme: light dark;
    }

    body {
      margin: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 1.5rem;
      background: radial-gradient(circle at top, #ffecd2, #fcb69f);
    }

    .card {
      background: rgba(255, 255, 255, 0.9);
      max-width: 600px;
      width: 100%;
      padding: 1.5rem 1.75rem;
      border-radius: 18px;
      box-shadow: 0 18px 40px rgba(0, 0, 0, 0.18);
      backdrop-filter: blur(10px);
    }

    h1, h2, h3 {
      margin-top: 0;
      color: #b22222;
    }

    .subtitle {
      margin-top: -0.5rem;
      margin-bottom: 1rem;
      font-size: 0.9rem;
      color: #555;
    }

    label {
      display: block;
      margin-top: 0.9rem;
      font-weight: 600;
      font-size: 0.9rem;
    }

    input[type="text"],
    input[type="date"],
    input[type="number"],
    textarea,
    select {
      width: 100%;
      padding: 0.55rem 0.7rem;
      border-radius: 10px;
      border: 1px solid #ccc;
      margin-top: 0.3rem;
      box-sizing: border-box;
      font-size: 0.9rem;
    }

    textarea {
      min-height: 120px;
      resize: vertical;
    }

    button {
      border: none;
      border-radius: 999px;
      padding: 0.6rem 1.3rem;
      font-weight: 600;
      font-size: 0.95rem;
      cursor: pointer;
      margin-top: 1rem;
      background: linear-gradient(135deg, #ff5f6d, #ffc371);
      color: #fff;
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.18);
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.15s;
    }

    button:hover {
      transform: translateY(-1px);
      box-shadow: 0 13px 30px rgba(0, 0, 0, 0.25);
      opacity: 0.95;
    }

    button:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
    }

    .btn-secondary {
      background: #eee;
      color: #333;
      box-shadow: none;
    }

    .btn-row {
      display: flex;
      gap: 0.6rem;
      flex-wrap: wrap;
    }

    .info-box {
      background: #fff8e6;
      border-radius: 12px;
      padding: 0.7rem 0.8rem;
      font-size: 0.85rem;
      margin-top: 0.7rem;
      border: 1px dashed #e0b35b;
      color: #5c470f;
    }

    .result-box {
      background: #f0fff4;
      border-radius: 12px;
      padding: 0.9rem 1rem;
      border: 1px solid #bde5c8;
      margin-top: 1rem;
      font-size: 0.95rem;
    }

    .error {
      color: #b00020;
      font-size: 0.85rem;
      margin-top: 0.4rem;
    }

    .field-hint {
      font-size: 0.8rem;
      color: #777;
      margin-top: 0.15rem;
    }

    .small-meta {
      font-size: 0.8rem;
      color: #666;
    }

    code {
      font-size: 0.8rem;
      padding: 0.15rem 0.3rem;
      border-radius: 4px;
      background: #f5f5f5;
    }

    .link-box {
      background: #f5f5ff;
      border-radius: 12px;
      padding: 0.75rem 0.9rem;
      font-size: 0.85rem;
      border: 1px solid #cfd4ff;
      margin-top: 0.9rem;
      word-break: break-all;
    }

    @media (max-width: 640px) {
      body {
        padding: 0.75rem;
      }
      .card {
        padding: 1.1rem 1.2rem;
        border-radius: 14px;
      }
    }
  </style>
</head>
<body>
  <div class="card" id="app">
    <!-- JS burayÄ± dolduracak -->
  </div>

  <script>
    // ---------- YardÄ±mcÄ± fonksiyonlar ----------

    function base64UrlEncode(str) {
      return btoa(unescape(encodeURIComponent(str)))
        .replace(/\+/g, '-')
        .replace(/\//g, '_')
        .replace(/=+$/, '');
    }

    function base64UrlDecode(str) {
      str = str.replace(/-/g, '+').replace(/_/g, '/');
      while (str.length % 4) str += '=';
      return decodeURIComponent(escape(atob(str)));
    }

    // Basit seed'li random (deterministik)
    function xmur3(str) {
      let h = 1779033703 ^ str.length;
      for (let i = 0; i < str.length; i++) {
        h = Math.imul(h ^ str.charCodeAt(i), 3432918353);
        h = (h << 13) | (h >>> 19);
      }
      return function() {
        h = Math.imul(h ^ (h >>> 16), 2246822507);
        h = Math.imul(h ^ (h >>> 13), 3266489909);
        h ^= h >>> 16;
        return h >>> 0;
      };
    }

    function mulberry32(a) {
      return function() {
        a |= 0;
        a = a + 0x6D2B79F5 | 0;
        let t = Math.imul(a ^ a >>> 15, 1 | a);
        t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
        return ((t ^ t >>> 14) >>> 0) / 4294967296;
      }
    }

    function makeSeededRng(seedStr) {
      const seedFn = xmur3(seedStr);
      const a = seedFn();
      return mulberry32(a);
    }

    // Ä°simlerden derangement (kimse kendini Ã§ekmiyor) Ã¼ret
    function makeDerangement(names, seedStr) {
      const rng = makeSeededRng(seedStr);
      const indices = names.map((_, i) => i);

      // Fisher-Yates shuffle
      for (let i = indices.length - 1; i > 0; i--) {
        const j = Math.floor(rng() * (i + 1));
        [indices[i], indices[j]] = [indices[j], indices[i]];
      }

      // Sabit nokta varsa dÃ¼zelt (kimse kendine Ã§Ä±kmasÄ±n)
      for (let i = 0; i < indices.length; i++) {
        if (indices[i] === i) {
          const swapWith = (i + 1) % indices.length;
          [indices[i], indices[swapWith]] = [indices[swapWith], indices[i]];
        }
      }
      return indices;
    }

    function randomSeed() {
      return Math.random().toString(36).slice(2, 10);
    }

    // URL'den etkinlik verisini Ã§ek
    function getEventFromUrl() {
      const hash = window.location.hash;
      if (!hash.startsWith('#data=')) return null;
      try {
        const encoded = hash.slice(6);
        const json = base64UrlDecode(encoded);
        const data = JSON.parse(json);
        if (!data || !Array.isArray(data.participants)) return null;
        return data;
      } catch (e) {
        console.error('Etkinlik verisi Ã§Ã¶zÃ¼lemedi', e);
        return null;
      }
    }

    function setEventToUrl(data) {
      const json = JSON.stringify(data);
      const encoded = base64UrlEncode(json);
      window.location.hash = 'data=' + encoded;
    }

    // ---------- UI render ----------

    const app = document.getElementById('app');

    function renderCreateView() {
      app.innerHTML = `
        <h1>Secret Santa EtkinliÄŸi OluÅŸtur</h1>
        <p class="subtitle">E-posta, telefon yok. Linki paylaÅŸ, herkes adÄ±nÄ± girip kime hediye alacaÄŸÄ±nÄ± gÃ¶rsÃ¼n.</p>

        <label>Etkinlik adÄ±</label>
        <input id="event-name" type="text" placeholder="Ã–rn: Aile YÄ±lbaÅŸÄ± Ã‡ekiliÅŸi">

        <label>Etkinlik tarihi</label>
        <input id="event-date" type="date">

        <label>BÃ¼tÃ§e (isteÄŸe baÄŸlÄ±)</label>
        <input id="event-budget" type="number" min="0" step="1" placeholder="Ã–rn: 300">

        <label>KatÄ±lÄ±mcÄ± listesi</label>
        <textarea id="event-participants" placeholder="Her satÄ±ra bir isim yazÄ±n:
AyÅŸe
Mehmet
Zeynep
..."></textarea>
        <div class="field-hint">TÃ¼m isimler benzersiz olmalÄ±. AynÄ± isim varsa yanÄ±na soyad/ilk harf ekleyin (Mehmet A., Mehmet B.).</div>

        <div class="info-box">
          Kurallar:
          <ul style="margin: 0.3rem 0 0 1.2rem; padding: 0;">
            <li>Ã‡ekiliÅŸ, isimler ve gizli bir anahtara gÃ¶re <strong>deterministik</strong> yapÄ±lÄ±r.</li>
            <li>Linki gÃ¶ren herkes aynÄ± eÅŸleÅŸmeleri gÃ¶rÃ¼r.</li>
            <li>Kimin kimi Ã§ektiÄŸi sayfaya kaydedilmez, sadece kiÅŸinin ekranÄ±nda gÃ¶sterilir.</li>
          </ul>
        </div>

        <div class="btn-row">
          <button id="create-btn">EtkinliÄŸi OluÅŸtur</button>
        </div>
        <div class="error" id="create-error"></div>
      `;

      document.getElementById('create-btn').addEventListener('click', () => {
        const name = document.getElementById('event-name').value.trim();
        const date = document.getElementById('event-date').value;
        const budgetRaw = document.getElementById('event-budget').value.trim();
        const participantsRaw = document.getElementById('event-participants').value.trim();
        const errorEl = document.getElementById('create-error');
        errorEl.textContent = '';

        if (!participantsRaw) {
          errorEl.textContent = 'En az 3 katÄ±lÄ±mcÄ± girmeniz gerekir.';
          return;
        }

        let participants = participantsRaw
          .split('\n')
          .map(s => s.trim())
          .filter(Boolean);

        const unique = new Set(participants);
        if (unique.size !== participants.length) {
          errorEl.textContent = 'Ä°simler benzersiz olmalÄ±. AynÄ± isimleri ayÄ±rt etmek iÃ§in soyad/ilk harf ekleyin.';
          return;
        }

        if (participants.length < 3) {
          errorEl.textContent = 'Secret Santa iÃ§in en az 3 kiÅŸi olmalÄ±.';
          return;
        }

        const budget = budgetRaw ? Number(budgetRaw) : null;

        const eventData = {
          name: name || 'Secret Santa',
          date: date || null,
          budget: budget,
          participants: participants,
          seed: randomSeed()
        };

        setEventToUrl(eventData);
        renderParticipantView(eventData, true);
      });
    }

    function renderParticipantView(eventData, justCreated = false) {
      const { name, date, budget, participants, seed } = eventData;

      app.innerHTML = `
        <h1>${name || 'Secret Santa'}</h1>
        <p class="subtitle">
          ${
            date
              ? `Etkinlik tarihi: <strong>${date}</strong>`
              : 'Tarih: katÄ±lÄ±mcÄ±lar kendi aranÄ±zda belirleyin.'
          }
        </p>

        ${
          budget != null
            ? `<div class="info-box">Hediye bÃ¼tÃ§esi: yaklaÅŸÄ±k <strong>${budget} â‚º</strong></div>`
            : ''
        }

        <label>Ä°smini seÃ§</label>
        <select id="participant-select">
          <option value="">-- Ä°smini seÃ§ --</option>
          ${participants.map(p => `<option value="${p}">${p}</option>`).join('')}
        </select>
        <div class="field-hint">Bu isim listesi sadece bu etkinliÄŸe Ã¶zeldir. Herkes kendi adÄ±nÄ± seÃ§melidir.</div>

        <div class="btn-row">
          <button id="show-btn">Kime hediye alacaÄŸÄ±mÄ± gÃ¶ster</button>
          <button id="copy-link-btn" class="btn-secondary">Etkinlik linkini kopyala</button>
        </div>

        <div class="result-box" id="result-box" style="display:none;"></div>
        <div class="error" id="participant-error"></div>

        <div class="link-box">
          <strong>Etkinlik linki:</strong><br>
          <span id="event-link"></span>
        </div>

        <p class="small-meta">
          Not: EÅŸleÅŸmeler, isimler ve gizli bir anahtar (<code>${seed}</code>) kullanÄ±larak belirlenir.
          Link deÄŸiÅŸmediÄŸi sÃ¼rece herkes aynÄ± sonuÃ§larÄ± gÃ¶rÃ¼r.
        </p>

        <div class="btn-row">
          <button id="back-btn" class="btn-secondary">Yeni etkinlik oluÅŸtur</button>
        </div>
      `;

      const linkSpan = document.getElementById('event-link');
      linkSpan.textContent = window.location.href;

      document.getElementById('show-btn').addEventListener('click', () => {
        const select = document.getElementById('participant-select');
        const name = select.value;
        const errorEl = document.getElementById('participant-error');
        const resultBox = document.getElementById('result-box');
        errorEl.textContent = '';

        if (!name) {
          errorEl.textContent = 'LÃ¼tfen Ã¶nce listeden kendi ismini seÃ§.';
          resultBox.style.display = 'none';
          return;
        }

        const index = participants.indexOf(name);
        if (index === -1) {
          errorEl.textContent = 'Ä°sim listesinde bir sorun var, sayfayÄ± yenilemeyi deneyin.';
          resultBox.style.display = 'none';
          return;
        }

        const permutation = makeDerangement(participants, seed);
        const assignedIndex = permutation[index];
        const targetName = participants[assignedIndex];

        resultBox.innerHTML = `
          <h3>SonuÃ§:</h3>
          <p><strong>${name}</strong> olarak senin hediye alacaÄŸÄ±n kiÅŸi:</p>
          <p style="font-size:1.3rem; font-weight:700; margin-top:0.4rem;">ğŸ ${targetName}</p>
          <p style="font-size:0.85rem; color:#333; margin-top:0.8rem;">
            Bu sonucu bir yere not et. SayfayÄ± yenilersen tekrar aynÄ± ismi gÃ¶receksin
            ama baÅŸkalarÄ±nÄ±n kime Ã§Ä±ktÄ±ÄŸÄ±nÄ± buradan gÃ¶remezsin.
          </p>
        `;
        resultBox.style.display = 'block';

        // AynÄ± tarayÄ±cÄ±da "bir kere gÃ¶rsÃ¼n" istiyorsan, buraya localStorage logic ekleyebilirsin.
      });

      document.getElementById('copy-link-btn').addEventListener('click', async () => {
        const url = window.location.href;
        try {
          await navigator.clipboard.writeText(url);
          alert('Etkinlik linki kopyalandÄ±. WhatsApp gruba yapÄ±ÅŸtÄ±rabilirsin.');
        } catch (e) {
          alert('Kopyalama baÅŸarÄ±sÄ±z oldu, linki elle seÃ§ip kopyalayabilirsiniz.');
        }
      });

      document.getElementById('back-btn').addEventListener('click', () => {
        // Hash'i temizle, yeni etkinlik ekranÄ±na dÃ¶n
        history.pushState("", document.title, window.location.pathname + window.location.search);
        renderCreateView();
      });

      if (justCreated) {
        // sayfa yeni oluÅŸturulduysa, kullanÄ±cÄ±nÄ±n direkt linki paylaÅŸabileceÄŸini hatÄ±rlatabiliriz
        // (alert yerine Ã¼stteki info-box zaten yeterli, o yÃ¼zden ekstra bir ÅŸey yapmÄ±yoruz)
      }
    }

    // ---------- BaÅŸlangÄ±Ã§ ----------

    function init() {
      const eventData = getEventFromUrl();
      if (eventData) {
        renderParticipantView(eventData, false);
      } else {
        renderCreateView();
      }
    }

    window.addEventListener('hashchange', init);
    init();
  </script>
</body>
</html>
